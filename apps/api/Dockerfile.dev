FROM node:18-alpine

# Instalar OpenSSL para Prisma
RUN apk add --no-cache openssl libc6-compat

# Instalar pnpm
RUN corepack enable && corepack prepare pnpm@8.15.0 --activate

WORKDIR /app

# Copiar archivos de configuración del monorepo
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml ./
COPY turbo.json ./

# Copiar configuración de Prisma
COPY prisma ./prisma

# Copiar paquetes compartidos
COPY packages/shared ./packages/shared

# Copiar configuración de la API
COPY apps/api/package.json ./apps/api/
COPY apps/api/tsconfig.json ./apps/api/

# Generar cliente Prisma usando el mismo enfoque que producción
# Instalar dependencias de la API con npm (más simple que pnpm en Docker)
WORKDIR /app/apps/api
# Quitar la dependencia de workspace que npm no entiende (igual que producción)
RUN sed -i 's/"@route-optimizer\/shared": "workspace:\*",//' package.json
RUN npm install --legacy-peer-deps

# Generar cliente Prisma (igual que producción)
RUN npx prisma generate --schema ../../prisma/schema.prisma

# Crear enlace al paquete shared en node_modules (igual que producción)
RUN mkdir -p node_modules/@route-optimizer && \
    ln -s /app/packages/shared node_modules/@route-optimizer/shared

# Ahora instalar dependencias del workspace completo con pnpm para desarrollo
WORKDIR /app
RUN pnpm install --frozen-lockfile || pnpm install

# El código fuente se montará como volumen en docker-compose
# No lo copiamos aquí para permitir hot reload

WORKDIR /app/apps/api

EXPOSE 3001

# Ejecutar en modo desarrollo con tsx watch para hot reload
CMD ["pnpm", "dev"]

