generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
  DRIVER
}

enum RouteStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum StopStatus {
  PENDING
  IN_TRANSIT
  ARRIVED
  COMPLETED
  FAILED
  SKIPPED
}

enum StopType {
  DELIVERY
  PICKUP
  SERVICE
  CHECKPOINT
}

enum GeocodeStatus {
  PENDING
  SUCCESS
  FAILED
  MANUAL
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  CANCELLED
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  role         UserRole  @default(DRIVER)
  phone        String?
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Driver preferences (JSON)
  preferences  Json?     @default("{}")

  // Push notifications
  fcmToken     String?   @map("fcm_token")

  // Relations
  createdRoutes    Route[]         @relation("CreatedRoutes")
  assignedRoutes   Route[]         @relation("AssignedRoutes")
  createdAddresses Address[]
  trackingPoints   TrackingPoint[]
  refreshTokens    RefreshToken[]

  @@map("users")
}

model Address {
  id               String        @id @default(uuid())
  street           String
  number           String?
  unit             String?       // Depto, Casa, Oficina, Local, etc.
  city             String
  state            String?
  postalCode       String?       @map("postal_code")
  country          String        @default("México")
  fullAddress      String        @map("full_address")
  latitude         Float?
  longitude        Float?
  geocodeStatus    GeocodeStatus @default(PENDING) @map("geocode_status")
  geocodeSource    String?       @map("geocode_source")
  isManualLocation Boolean       @default(false) @map("is_manual_location")
  customerName     String?       @map("customer_name")
  customerPhone    String?       @map("customer_phone")
  notes            String?
  createdById      String        @map("created_by_id")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  createdBy User   @relation(fields: [createdById], references: [id])
  stops     Stop[]

  @@index([geocodeStatus])
  @@index([createdById])
  @@map("addresses")
}

model Route {
  id               String      @id @default(uuid())
  name             String
  description      String?
  status           RouteStatus @default(DRAFT)
  scheduledDate    DateTime?   @map("scheduled_date")
  startedAt        DateTime?   @map("started_at")
  completedAt      DateTime?   @map("completed_at")
  totalDistanceKm  Float?      @map("total_distance_km")
  totalDurationMin Int?        @map("total_duration_min")
  optimizedAt      DateTime?   @map("optimized_at")
  optimizationHash String?     @map("optimization_hash") // Hash of stops to detect changes
  departureTime    String?     @map("departure_time") // HH:mm format, overrides depot default
  depotReturnTime  DateTime?   @map("depot_return_time") // Estimated arrival back at depot

  // Driver workflow timestamps
  sentAt          DateTime? @map("sent_at") // When route was sent to driver (visible in app)
  loadedAt        DateTime? @map("loaded_at") // When truck was loaded
  actualStartTime DateTime? @map("actual_start_time") // Real start time (vs scheduled)
  pausedAt        DateTime? @map("paused_at") // When route was paused

  // Live driver location
  driverLatitude   Float?    @map("driver_latitude")
  driverLongitude  Float?    @map("driver_longitude")
  driverLocationAt DateTime? @map("driver_location_at")
  driverHeading    Float?    @map("driver_heading") // Direction 0-360°
  driverSpeed      Float?    @map("driver_speed") // km/h

  // Depot (origin point)
  depotId         String? @map("depot_id")
  originLatitude  Float?  @map("origin_latitude")
  originLongitude Float?  @map("origin_longitude")
  originAddress   String? @map("origin_address")

  createdById  String   @map("created_by_id")
  assignedToId String?  @map("assigned_to_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy      User            @relation("CreatedRoutes", fields: [createdById], references: [id])
  assignedTo     User?           @relation("AssignedRoutes", fields: [assignedToId], references: [id])
  depot          Depot?          @relation("DepotRoutes", fields: [depotId], references: [id])
  stops          Stop[]
  trackingPoints TrackingPoint[]

  @@index([status])
  @@index([scheduledDate])
  @@index([createdById])
  @@index([assignedToId])
  @@index([depotId])
  @@map("routes")
}

model Stop {
  id            String     @id @default(uuid())
  routeId       String     @map("route_id")
  addressId     String     @map("address_id")
  sequenceOrder Int        @map("sequence_order")
  status        StopStatus @default(PENDING)

  // Stop configuration
  stopType         StopType @default(DELIVERY) @map("stop_type")
  estimatedMinutes Int      @default(15) @map("estimated_minutes")
  priority         Int      @default(0)

  // Time window
  timeWindowStart DateTime? @map("time_window_start")
  timeWindowEnd   DateTime? @map("time_window_end")

  // Recipient info
  recipientName  String? @map("recipient_name")
  recipientPhone String? @map("recipient_phone")
  recipientEmail String? @map("recipient_email")

  // Proof of delivery settings
  requireSignature Boolean @default(false) @map("require_signature")
  requirePhoto     Boolean @default(false) @map("require_photo")
  proofEnabled     Boolean @default(true) @map("proof_enabled")

  // Order information
  clientName   String? @map("client_name")
  packageCount Int     @default(1) @map("package_count")
  products     String? // JSON string of products
  externalId   String? @map("external_id")
  barcodeIds   String? @map("barcode_ids") // Comma separated
  sellerName   String? @map("seller_name")
  orderNotes   String? @map("order_notes")

  // Delivery tracking
  travelMinutesFromPrevious Int?      @map("travel_minutes_from_previous") // Travel time from previous stop (or depot)
  estimatedArrival          DateTime? @map("estimated_arrival") // Current ETA (recalculated)
  originalEstimatedArrival  DateTime? @map("original_estimated_arrival") // ETA at route start (frozen)
  arrivedAt                 DateTime? @map("arrived_at")
  completedAt               DateTime? @map("completed_at")

  // Proof of delivery captured
  notes         String?
  signatureUrl  String? @map("signature_url")
  photoUrl      String? @map("photo_url")
  failureReason String? @map("failure_reason")

  // Payment information
  isPaid           Boolean       @default(false) @map("is_paid")
  paymentStatus    PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod    String?       @map("payment_method") // CASH, CARD, TRANSFER, etc.
  paymentAmount    Float?        @map("payment_amount") // Expected amount
  collectionAmount Float?        @map("collection_amount") // Actually collected
  paymentNotes     String?       @map("payment_notes")
  paidAt           DateTime?     @map("paid_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  route   Route   @relation(fields: [routeId], references: [id], onDelete: Cascade)
  address Address @relation(fields: [addressId], references: [id])

  @@unique([routeId, sequenceOrder])
  @@index([routeId])
  @@index([status])
  @@index([paymentStatus])
  @@index([isPaid])
  @@map("stops")
}

model TrackingPoint {
  id         String   @id @default(uuid())
  routeId    String   @map("route_id")
  userId     String   @map("user_id")
  latitude   Float
  longitude  Float
  accuracy   Float?
  speed      Float?
  heading    Float?
  recordedAt DateTime @map("recorded_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@index([routeId, recordedAt])
  @@index([userId])
  @@map("tracking_points")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}

// Settings - Configuración global del sistema
model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// Depot - Punto de salida/origen de las rutas (solo ubicación física)
model Depot {
  id        String  @id @default(uuid())
  name      String
  address   String
  latitude  Float
  longitude Float
  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  // Default schedule
  defaultDepartureTime  String @default("08:00") @map("default_departure_time") // HH:mm format
  defaultServiceMinutes Int    @default(15) @map("default_service_minutes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  routes Route[] @relation("DepotRoutes")

  @@map("depots")
}
